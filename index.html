<html>
<head>
<title>Library Voices</title>
<script src="src/lib/infusion/infusion-all.js"></script>
</head>

<body>
    <h1>Library Voices</h1>
    <p>This page uses the same WebSocket feed of anonymized realtime search data from Toronto Public Library as the <a href="http://dashboard.tpllabs.ca/index.html">Dashboard project</a>.</p>

    <p>However, it streams it to the textToSpeech API of the browser rather than to the screen.</p>

    <p>Tested in Chrome on Mac only at this point.</p>

    <p>Not an official TPL thing, made by <a href="https://twitter.com/waharnum">Alan Harnum</a>.</p>

    <a href="#" id="pleaseMakeItStop">Please Make It Stop</a>
    <span id="loggingArea"></span>

<script>

var textToSpeech = fluid.textToSpeech({});

var getRandomInt = function(min, max) {
    console.log(min, max)
     return Math.floor(Math.random() * (max - min)) + min;
}

$(document).ready(function ()  {

    // var ttsBeforeStopping = 5;
    var socket;

    $("#pleaseMakeItStop").click(function (e) {
        socket.close();
        textToSpeech.cancel();
        e.preventDefault();
    });

    socket = new WebSocket("ws://45.55.209.67:4571/rtsearches");
    socket.onmessage = function (e) {
        var terms = JSON.parse(e.data)[0].terms
        var availableVoices = fluid.copy(textToSpeech.getVoices());

        // Filter to English-only voices
        fluid.remove_if(availableVoices, function (voice) {
            return voice.lang.indexOf("en-") < 0;
        });

        // Get a random voices
        var random = getRandomInt(0, availableVoices.length);
        var voiceToUse = availableVoices[random];

        if(voiceToUse) {
            textToSpeech.applier.change("utteranceOpts.lang", voiceToUse.lang);
            textToSpeech.applier.change("utteranceOpts.voiceURI", voiceToUse.voiceURI);
            textToSpeech.applier.change("utteranceOpts.voice", voiceToUse);
        }

        textToSpeech.queueSpeech(terms);
    };

});

</script>

</body>

</html>
